---
title: "Disability Employment"
output:
  html_notebook:
    code_folding: hide
    toc: TRUE
    toc_float: TRUE
    
---

```{css, echo = FALSE}
body {
  font-family: Poppins;
}
```

**Disability Employment Awareness Data Sources**

- 2022 ACS 5-year B18120 Employment Status by Disability Status and Type (Civilian Noninstitutionalized Population 18 to 64 Years)
<!-- B18121 Work Experience by Disability Status and Type -->
<!-- B18130 Age by Disability Status by Poverty Status -->

- 2021 1 year PUMS variables: 
  - DIS (disability flag)
  - OCCP (Occupation recode based on 2018 OCC codes)
  - LUM_JOBSECTOR (Modeling Sectors)

**Information**

[Census Stats](https://www.census.gov/newsroom/stories/disability-employment-awareness-month.html)

The tables include the coefficient of variation (CV) measures which is the relative amount of sampling error that is associated with a sample estimate. See [this article](https://psrc.github.io/psrccensus/articles/calculate-reliability-moe-transformed-acs.html) for interpretation.

```{r, echo = FALSE}
library(psrccensus)
library(psrcplot)
library(tidyverse)
library(tidycensus)
library(DT)
library(openxlsx)

source('functions.R')
```

```{r B18120 Employment Status, echo = FALSE}
x <- get_acs_recs('county', table.names = 'B18120', years = '2022', acs.type = 'acs1')

x02 <- x %>% 
  mutate(variable_sort = str_extract(variable, "\\d{2}$")) %>% 
  mutate(label02 = label) %>% 
  separate(label02,
           sep = ":!!",
           into = c('total', 'in_lf', 'is_emp', 'has_dis', 'dis_type')) %>%
  mutate(dis_type = ifelse(variable_sort %in% 23:28, has_dis, dis_type)) %>%
  mutate(has_dis = ifelse(variable_sort %in% 22:29, is_emp, has_dis)) %>%
  mutate(is_emp = ifelse(variable_sort %in% 22:29, NA, is_emp)) %>% 
  mutate(in_lf = str_replace_all(in_lf, ":", ""),
         is_emp = str_replace_all(is_emp, ":", ""),
         has_dis = str_replace_all(has_dis, ":", ""))
```

```{r region}
  
r <- x02 %>% 
  filter(name == 'Region')
```

# Disability in Region (as a whole)

```{r region with disability, echo = FALSE}
w_dis <- c('04', '13', '22')
wo_dis <- c('11', '20', '29')

r_tot <- r %>% 
  filter(variable_sort == '01') %>% 
  select(acs_type, year, name, denom_est = estimate, denom_moe = moe)

r_dis <- r %>%
  filter(variable_sort %in% c(w_dis, wo_dis)) %>% 
  group_by(name, has_dis) %>%
  summarise(estimate = sum(estimate),
            moe = moe_sum(moe = moe, estimate = estimate)) %>%
  mutate(se = moe/1.645) %>% 
  mutate(cv = (se/estimate)) %>% 
  left_join(r_tot, by = 'name') %>% 
  mutate(share_est = estimate/denom_est,
         share_moe = moe_prop(estimate, denom_est, moe, denom_moe))

r_dis_fmt <- r_dis %>% 
  select(-se, -denom_est, -denom_moe) %>% 
  relocate(any_of(c("acs_type", "year")), .before = name)

datatable(r_dis_fmt) %>%
  formatRound(columns=c('estimate'), digits = 0) %>% 
  formatRound(columns=c('moe', 'cv'), digits = 2) %>% 
  formatPercentage(c('cv', 'share_est', 'share_moe'), 1)
  
```

- 9.7% of people in the Central Puget Sound Region between the ages of 18-64 report having a disability 

## Disability types

```{r region disability types, echo = FALSE}

#4, 13, 22 "With disability" total

r_dis_type_denom <- r %>% 
  filter(variable_sort == '01') %>% 
  group_by(name) %>% 
  summarise(denom_est = sum(estimate),
            denom_moe = moe_sum(moe = moe, estimate = estimate))

r_dis_type <- r %>% 
  filter(has_dis == 'With a disability') %>% 
  filter(!(variable_sort %in% c('04', '13', '22'))) %>% # 444,261 
  group_by(acs_type, year, name, dis_type) %>%
  summarise(estimate = sum(estimate),
            moe = moe_sum(moe = moe, estimate = estimate)) %>% 
  mutate(se = moe/1.645) %>% 
  mutate(cv = (se/estimate)) %>% 
  left_join(r_dis_type_denom, by = 'name') %>% 
  mutate(share_est = estimate/denom_est,
         share_moe = moe_prop(estimate, denom_est, moe, denom_moe))

r_dis_type_fmt <- r_dis_type %>% 
  select(-se, -denom_est, -denom_moe)

datatable(r_dis_type_fmt)%>%
  formatRound(columns=c('estimate'), digits = 0) %>% 
  formatRound(columns=c('moe'), digits = 2) %>% 
  formatPercentage(c('cv', 'share_est', 'share_moe'), 1)

```

* Individuals can report more than one disability. Aggregating all disability types will not equal the reported 'With a disability' totals.

- Most individuals in the region with a disability report at least a cognitive difficulty followed by independent living difficulty, and an ambulatory difficulty

```{r}
ggplot(r_dis_type_fmt, aes(dis_type, share_est, fill = dis_type)) +
  geom_col(position = 'dodge') +
  scale_y_continuous(labels = scales::percent_format()) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) +
  geom_linerange(aes(ymax = share_est + share_moe, ymin = share_est - share_moe),
                position = position_dodge2(width = 0, padding = 0.5)) +
  labs(y = NULL,
       x = NULL) +
  theme(legend.title = element_blank(),
        legend.position = "none")
```

# Within the Labor Force


```{r in labor force with disability}
# in labor force, emp/ump, with a disability

r_lf_emp_dis_denom <- r %>%
  filter(variable_sort %in% c('01', '02')) %>%
  mutate(label02 = label) %>% 
  mutate(label02 = str_replace_all(label02, ".*In the labor force.*", "in_lf"),
         label02 = str_replace_all(label02, ".*Total.*", "reg_tot")) %>% 
  pivot_wider(id_cols = c('name'),
              names_from = 'label02',
              names_glue = "denom_{label02}_{.value}",
              values_from = c('estimate', 'moe'))
  
lf_rows <- c('04', '11', '13', '20')

r_lf_emp_dis <- r %>% 
  filter(variable_sort %in% lf_rows) %>% 
  mutate(se = moe/1.645) %>% 
  mutate(cv = (se/estimate)) %>% 
  left_join(r_lf_emp_dis_denom, by = 'name') %>% 
  mutate(share_est_reg = estimate/denom_reg_tot_estimate,
         share_moe_reg = moe_prop(estimate, denom_reg_tot_estimate, moe, denom_reg_tot_moe),
         share_est_inlf = estimate/denom_in_lf_estimate,
         share_moe_inlf = moe_prop(estimate, denom_in_lf_estimate, moe, denom_in_lf_moe))
  
r_lf_emp_dis_fmt <- r_lf_emp_dis %>% 
  select(acs_type, year, name, in_lf, is_emp, has_dis, estimate, moe, cv, starts_with('share'))

datatable(r_lf_emp_dis_fmt) %>%
  formatRound(columns=c('estimate'), digits = 0) %>% 
  formatRound(columns=c('moe'), digits = 2) %>% 
  formatPercentage(9:13, 1)


```

Of those in the labor force

- 6.3% (approx 139,000 persons) with a disability are employed
- Individuals with a disability and unemployed represent 0.6% (12,700 persons) of the labor force

# Not in the Labor Force
```{r not in labor force with disability}
# NOT in labor force, with a disability

r_not_lf_dis_denom <- r %>%
  filter(variable_sort %in% c('01', '21')) %>%
  mutate(label02 = label) %>% 
  mutate(label02 = str_replace_all(label02, ".*Not in labor force.*", "in_lf"),
         label02 = str_replace_all(label02, ".*Total.*", "reg_tot")) %>% 
  pivot_wider(id_cols = 'name',
              names_from = 'label02',
              names_glue = "denom_{label02}_{.value}",
              values_from = c('estimate', 'moe'))
  
not_lf_rows <- c('22', '29')

r_not_lf_dis <- r %>% 
  filter(variable_sort %in% not_lf_rows) %>% 
  mutate(se = moe/1.645) %>% 
  mutate(cv = (se/estimate)) %>% 
  left_join(r_not_lf_dis_denom, by = 'name') %>% 
  mutate(share_est_reg = estimate/denom_reg_tot_estimate,
         share_moe_reg = moe_prop(estimate, denom_reg_tot_estimate, moe, denom_reg_tot_moe),
         share_est_inlf = estimate/denom_in_lf_estimate,
         share_moe_inlf = moe_prop(estimate, denom_in_lf_estimate, moe, denom_in_lf_moe))
  
r_not_lf_dis_fmt <- r_not_lf_dis %>% 
  select(acs_type, year, name, in_lf, is_emp, has_dis, estimate, moe, cv, starts_with('share'))

datatable(r_not_lf_dis_fmt) %>%
  formatRound(columns=c('estimate'), digits = 0) %>% 
  formatRound(columns=c('moe'), digits = 2) %>% 
  formatPercentage(9:13, 1)


```

<!-- X% are not in in the labor force -->

- Of those not in the labor force, 21.8% percent report a disability 

# Work Experience by Disability Status and Type

```{r B18121 Work Experience by Disability Status and Type, echo = FALSE}
we <- get_acs_recs('county', table.names = 'B18121', years = '2022', acs.type = 'acs1')

we02 <- we %>%
  mutate(variable_sort = str_extract(variable, "\\d{2}$")) %>%
  mutate(label02 = label) %>%
  separate(label02,
           sep = ":!!",
           into = c('total', 'duration', 'has_dis', 'dis_type')) %>%
  mutate(duration = str_replace_all(duration, ":", ""),
         has_dis = str_replace_all(has_dis, ":", ""))
```

```{r}

r_we <- we02 %>% 
  filter(name == 'Region')

exc_we_rows <- c('01', '02', '11', '12', '20', '21')

r_we_denom <- r_we %>% 
  filter(variable_sort %in% '01') %>% 
  select(name, denom_est = estimate, denom_moe = moe)
```

```{r}


r_we_grp <- r_we %>% 
  filter(!(variable_sort %in% exc_we_rows)) %>% 
  mutate(is_wrk = ifelse(str_detect(duration, "Worked.*"), "Worked", "Not Worked")) %>% 
  group_by(acs_type, year, name, is_wrk, has_dis) %>% 
  summarise(estimate = sum(estimate),
            moe = moe_sum(moe = moe, estimate = estimate)) %>% 
  mutate(se = moe/1.645) %>% 
  mutate(cv = (se/estimate)) %>% 
  left_join(r_we_denom, by = 'name') %>% 
  mutate(share_est = estimate/denom_est,
         share_moe = moe_prop(estimate, denom_est, moe, denom_moe))

r_we_grp_fmt <- r_we_grp %>% 
  select(acs_type, year, name, is_wrk, has_dis, estimate, moe, cv, starts_with('share'))

datatable(r_we_grp_fmt) %>%
  formatRound(columns=c('estimate'), digits = 0) %>% 
  formatRound(columns=c('moe'), digits = 2) %>% 
  formatPercentage(c('cv', 'share_est', 'share_moe'), 1)

```
```{r}
ggplot(r_we_grp_fmt, aes(x = is_wrk, y = share_est, fill = has_dis)) +
  geom_col(position = 'dodge') +
  scale_y_continuous(labels = scales::percent_format()) +
  geom_linerange(aes(ymax = share_est + share_moe, ymin = share_est - share_moe),
                position = position_dodge2(width = 1, padding = 0.5)) +
  labs(y = NULL,
       x = NULL) +
  theme(legend.title = element_blank())

  
```


```{r}

# r_we_denom <- r_we %>% 
#   filter(variable_sort %in% '01') %>% 
#   select(name, denom_est = estimate, denom_moe = moe)

r_we_dis <- r_we %>% 
  filter(!(variable_sort %in% exc_we_rows)) %>% 
  group_by(acs_type, year, name, duration, has_dis) %>% 
  summarise(estimate = sum(estimate),
            moe = moe_sum(moe = moe, estimate = estimate)) %>%
  mutate(se = moe/1.645) %>% 
  mutate(cv = (se/estimate)) %>% 
  left_join(r_we_denom, by = 'name') %>% 
  mutate(share_est = estimate/denom_est,
         share_moe = moe_prop(estimate, denom_est, moe, denom_moe))

r_we_dis_fmt <- r_we_dis %>% 
  select(acs_type, year, name, duration, has_dis, estimate, moe, cv, starts_with('share'))

datatable(r_we_dis_fmt) %>%
  formatRound(columns=c('estimate'), digits = 0) %>% 
  formatRound(columns=c('moe'), digits = 2) %>% 
  formatPercentage(c('cv', 'share_est', 'share_moe'), 1)

```

```{r}
ggplot(r_we_dis_fmt, aes(x = duration, y = share_est, fill = has_dis)) +
  geom_col(position = 'dodge') +
  scale_y_continuous(labels = scales::percent_format()) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) +
  geom_linerange(aes(ymax = share_est + share_moe, ymin = share_est - share_moe),
                position = position_dodge2(width = 1, padding = 0.5)) +
  labs(y = NULL,
       x = NULL) +
  theme(legend.title = element_blank())
```

# Disability Employment by Occupation (PUMS)
```{r PUMS test, eval = FALSE, include = FALSE}
x <- pums_vars_2021 %>% 
  filter(str_detect(var_label, ".*[d|D]isability.*"))

y <- pums_vars_2021 %>% 
  filter(str_detect(var_label, ".*[w|W]orker.*"))

pums_varsearch(".*[d|D]isability.*")
pums_varsearch("OCCP")
pums_varsearch("LUM_JOBSECTOR")


```

```{r PUMS Occp, echo=FALSE}

# COW (class of worker)
# DIS (Disability recode)
# https://psrc.github.io/psrccensus/articles/pums-1-basics.html
# https://www.census.gov/topics/health/disability/guidance/data-collection-acs.html

dis_wrkclass_pums <- get_psrc_pums(span = 1,                     # Denoting ACS 5-year estimates; 1-year also available
                   dyear = 2021,                                 # Last data year of span
                   level = "p",                                  # Unit of analysis == household ("p" used for person)
                   vars = c("OCCP",                              # Occupation recode based on 2018 OCC codes
                            # "COW",                             # Class of Worker
                            "DIS"                                # Disability recode
                            ))       

```

```{r, include = FALSE}

occ_lu <- read.xlsx('occp.xlsx')

dis_wrkclass_overview <- psrc_pums_count(dis_wrkclass_pums, group_vars = c("OCCP",  # Occupation recode based on 2018 OCC codes
                                                                           # "COW", # Class of Worker
                                                                           "DIS"    # Disability recode
                                                                           )) 

dis_wrkclass_overview02 <- dis_wrkclass_overview %>% 
  separate(OCCP,
           into = c("occp_abbr", "occp_desc"),
           sep = "-")

dis_wrkclass_overview03 <- dis_wrkclass_overview02 %>% 
  filter(DIS != 'Total') %>% 
  group_by(DATA_YEAR, COUNTY, occp_abbr, DIS) %>% 
  summarise(count = sum(count), count_moe = moe_sum(estimate = count, moe = count_moe)) %>% 
  mutate(se = count_moe/1.645) %>% 
  mutate(cv = (se/count))

dis_wrkclass_denom <- dis_wrkclass_overview02 %>% 
  filter(occp_abbr == 'Total') %>% 
  select(COUNTY, count_denom = count, moe_denom = count_moe)

dis_wrkclass_overview04 <- dis_wrkclass_overview03 %>% 
  left_join(dis_wrkclass_denom, by = 'COUNTY') %>% 
  group_by(DATA_YEAR, COUNTY, occp_abbr, DIS) %>% 
  summarise(count, count_moe, cv, share = count/count_denom, share_moe = moe_prop(count, count_denom, count_moe, moe_denom)) %>% 
  left_join(occ_lu, by = "occp_abbr")

dis_wrkclass_overview_fmt <- dis_wrkclass_overview04 %>% 
  select(DATA_YEAR, COUNTY, occp_abbr, definition, DIS, count, count_moe, cv, share, share_moe)



```

Workers with disabilities work in various occupations

- 6% of those in the region who have reported a disability did not report the sector they work in
- The remainder of individuals who have reported a disability reported employment in various occupations. The top 3 occupations are:
    - Office And Administrative Support Workers (.6%)
    - Managerial roles (.5%)
    - Sales And Related Workers (.5%)

**Disability status by Occupation (with disability only)**
```{r}
dis_wrkclass_overview_fmt_disonly <- dis_wrkclass_overview_fmt %>% 
  filter(DIS == 'With a disability')

datatable(dis_wrkclass_overview_fmt_disonly) %>%
  formatRound(columns=c('count'), digits = 0) %>% 
  formatRound(columns=c('count_moe'), digits = 2) %>% 
  formatPercentage(8:9, 1)

```
**Detailed Disability Status by Occupation**
```{r}
datatable(dis_wrkclass_overview_fmt) %>%
  formatRound(columns=c('count'), digits = 0) %>% 
  formatRound(columns=c('count_moe'), digits = 2) %>% 
  formatPercentage(8:9, 1)
```

# Disability Employment by Job Sectors (PUMS) 

## PSRC Land Use Modeling Job Sectors
```{r PUMS model job sectors}

dis_modsect_overview_fmt_2021 <- create_modsect_pums_table(span = 1, dyear = 2021)
dis_modsect_overview_fmt_2020 <- create_modsect_pums_table(span = 5, dyear = 2020)

dis_modsect_overview_fmt <- bind_rows(dis_modsect_overview_fmt_2021, dis_modsect_overview_fmt_2020)

```

```{r export data}
# export as xlsx

```

**Detailed Disability Status by Modeling Sectors**
```{r}
datatable(dis_modsect_overview_fmt) %>%
  formatRound(columns=c('count'), digits = 0) %>% 
  formatRound(columns=c('count_moe'), digits = 2) %>% 
  formatPercentage(7:9, 1)
```


```{r}
dis_modsect_overview_fmt_plot <- dis_modsect_overview_fmt %>% 
  mutate(sector = str_extract(LUM_JOBSECTOR, "(?<=-).*")) %>% 
  mutate(DATA_YEAR = factor(DATA_YEAR, levels = c('2020', '2021'))) %>% 
  filter(!is.na(LUM_JOBSECTOR) & DIS == 'With a disability') # a lot of NAs for sector, focus only on disability emp

ggplot(dis_modsect_overview_fmt_plot, aes(x = sector, y = share, fill = DATA_YEAR)) +
  geom_col(position = 'dodge') +
  scale_y_continuous(labels = scales::percent_format()) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) +
  geom_linerange(aes(ymax = share + share_moe, ymin = share - share_moe),
                position = position_dodge2(width = 1, padding = 0.5)) +
  labs(y = NULL,
       x = NULL,
       title = 'Workers with Disabilities by Job Sector',
       caption = 'Based on sectors used for land use modeling') +
  theme(legend.title = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=.5))

```
Workers with Disabilities by Job Sector

**2020**


**2021**

- 6.5% of the region's population report a disability but not the sector they work in
- 1% of the region's population are workers in Business Services who reported a disability while 0.7% work in Retail, 0.6% in Healthcare, and 0.5% in Manufacturing
- The sectors listed are used for PSRC's land use modeling

## PSRC Covered Employment Job Sectors 
```{r PUMS Covered Employment job sectors}

# create function

```

